<!DOCTYPE html>
<html>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Automatische Bibelstellenerkennung (Demo)</title>
    <style>
        main { max-width: 1200px; margin: auto; }
        .half-container { display: flex; flex-wrap: wrap; }
        .half-box {
            flex: 1; display: flex; flex-direction: column;
            justify-content: top;
            margin: 20px;
            min-width: 280px; max-width: 550px;
        }
        .half-box > div { padding: 20px; }
        #user-input { border: 1px dashed green; }
        #results { border: 1px dashed red; }
        #results:empty:not(:focus):before{content:attr(data-defaulttext)}
        #booknames { font-size: 0.6em; overflow-wrap: break-word; }
    </style>
<body>
    <main>
        <h1>Automatische Bibelstellenerkennung (Demo)</h1>
        <div class="half-container">
            <div id="content" class="half-box">
                <p>Hier Text anpassen/eingeben, der Bibelstellen enthält:</p>
                <div contentEditable="true" id="user-input">
                Bibelstellen können einzelne Verse referenzieren, wie 1. Mo 4, 23 oder mehrere Verse umfassen Jos 4, 12-20. 
                Auch Kapitel übergreifende Angaben werden erkannt: 1. Mo 1,15 - 2,4.
                Mal steht hinter dem Buch ein Punkt Röm. 4,1 oder es fehlt das Leerzeichen und kein Vers angegeben Offb22.
                <br /><br />
                Auch Bibelverse mit Punkt getrennt werden erkannt: 1. Mo 3,4.7-9.20.
                Zeilenumbrüche Gen 2,<br />
                23 sind kein Problem.
                </div>
            </div>
            <div id="detection" class="half-box">
                <p>Erkannte Bibelstellen:</p>
                <div id="results" data-defaulttext="Keine Bibelstellen erkannt."></div>
            </div>
        </div>
        <div>
            <h3>Beschränkungen:</h3>
            <ul>
                <li>Nur deutsche Notationen und Buchnamen werden erkannt</li>
                <li>Nicht alle Varianten der Buchnamen werden erkannt (siehe unten)</li>
                <!--<li>Es erfolgt keine Prüfung ob der Vers/das Kapitel wirklich existiert (z.B. 1. Mo 4,99; Obd 2,1)</li>-->
                <li>Bei Büchern mit nur einem Kapitel muss die Kapitelnummer 1 mit angegeben werden. Obd 10 für Obd 1,10 wird nicht erkannt.</li>
                <li>Wenn man dem Link folgt: bibleserver.com erkennt beim Markieren nicht alle Varianten der Versangabe</li>
            </ul>
            <h3>Bekannte Buchnamen:</h3>
            <p id="booknames"></p>
        </div>
        <!--
        <div>
            <h3>Mögliche Weiterentwicklung:</h3>
            <ul>
                <li>Speicherung der Nutzereingaben im local storage</li>
                <li>OCR-Erkennung (z.B. mit einer mobilen App)</li>
                <li>Statt Texteingabe Angabe einer URL (erfordert Backend oder lokale Installation)</li>
                <li>Druckfunktion</li>
                <li>Apps für Desktop und mobile Geräte</li>
                <li>Inhaltsanalyse von Bibeltexten, statistische Auswertung</li>
                <li>Performance-Verbesserung: Input-Events cachen</li>
            </ul>
            <h3>USPs</h3>
            <ul>
                <li>Einfache Zusammenstellung von Bibelstellen für Bibelarbeiten u.ä.</li>
                <li>Benutzung ohne Installation/Anmeldung</li>
                
        </div>-->
    </main>
    
    <script src="bundle.js"></script>
    <script>
        const UserNotes = (function (storage, inputElement) {
            const STORAGE_KEY = 'userNotes';
            const _getUserInput = () => inputElement.innerText;
            return {
                get: _getUserInput,
                save: () => storage.setItem(STORAGE_KEY, _getUserInput()),
                restore: () => {
                    const storageContent = storage.getItem(STORAGE_KEY);
                    if (storageContent.trim()) {
                        inputElement.innerText = storageContent;
                    }
                }
            }
        }(localStorage, document.getElementById('user-input')));

        const EventWorker = (function () {
            let pending = false;
            let next = null;
            let timer = 0;

            const reset = () => {
                if (timer > 0) {
                    console.log(`worker took ${Date.now() - timer}ms`);
                }
                next = null;
                pending = false;
            }

            const doNext = () => {
                if (next && !pending) {
                    pending = true;
                    timer = Date.now();
                    next().then(() => {
                        reset();
                    }).catch((err) => {
                        reset();
                        console.error('catched error', err);
                    });
                }
            }

            window.setInterval(doNext, 1000);
            
            return {
                add: (work) => next = work
            }
        }());

        const BibleTextRenderer = (function (outputElement) {
            const renderBibleReferences = (rawReference, nestedVerses) => {
                const uriEscapeReference = (reference) => encodeURIComponent(reference.replace(/\s/g, ''));
                const generateBibleServerLink = (reference) => `https://bibleserver.com/text/LUT/${uriEscapeReference(reference)}`;
                // TODO html escaping
                const referenceTemplate = (reference, bibleText) => `<p>${reference}:
                    <small><a href="${generateBibleServerLink(reference)}" target="_blank">
                        Öffne auf bibleserver.com
                    </a></small></p><p>${bibleText}</p>`;
                const verseRangeToString = (verseRange) => verseRange.map((verse) => `<small>${verse.verse}</small> ${verse.text}`).join(' ');

                const flattenedVerses = [].concat(...nestedVerses);
                return referenceTemplate(rawReference, verseRangeToString(flattenedVerses));
            };
            const displayBibleVerses = (flattenedVerses) => outputElement.innerHTML = flattenedVerses.join('');
            
            return {renderBibleReferences, displayBibleVerses};
        }(document.getElementById('results')));
    </script>
    <script>
        const getBibleTextForReference = ({raw, resolved}) => 
            window.reader.getVerse(resolved).then((bibleText) => BibleTextRenderer.renderBibleReferences(raw, bibleText));

        const detectAndResolveBibleReferences = (inputText) => {
            const removeWhitespace = (reference) => reference.replace(/\s/g, '');
            const rawReferences = window.detect.detectReference(inputText);
            const resolveReference = (reference) => window.detect.resolveReference(removeWhitespace(reference));
            return rawReferences.map((reference) => ({ raw: reference, resolved: resolveReference(reference)}));
        };

        const detectBibleReferencesInUserInput = () => {
            UserNotes.save();
            const bibelReferences = detectAndResolveBibleReferences(UserNotes.get());
            return Promise.all(bibelReferences.map(getBibleTextForReference)).then(BibleTextRenderer.displayBibleVerses);
        };

        UserNotes.restore();
        detectBibleReferencesInUserInput();
        document.getElementById('user-input').addEventListener("input", () => EventWorker.add(detectBibleReferencesInUserInput));
        document.getElementById('booknames').innerHTML = window.detect._booknames.join(',');
    </script>
</body>
</html>